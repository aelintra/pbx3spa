<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IVR Add – Logic Flow</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true, theme: 'neutral' });</script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 1rem; }
    h1 { font-size: 1.25rem; }
    h2 { font-size: 1.1rem; margin-top: 2rem; color: #333; }
    .mermaid { margin: 1rem 0; min-height: 200px; }
    .mermaid svg { max-width: 100%; }
  </style>
</head>
<body>
  <h1>IVR Add – Logic Flow (for SPA replacement)</h1>
  <p>Flowchart of logic paths through the “add new IVR” code.</p>

  <h2>1. High-level flow (entry → outcome)</h2>
  <div class="mermaid">
flowchart TD
    Start([User on IVR list]) --> ClickNew[Click New]
    ClickNew --> RouteNew{GET/POST new?}
    RouteNew -->|Yes| ShowNew[showNew: render form]
    RouteNew -->|No| OtherRoutes[Other showForm branches...]
    ShowNew --> FormDisplay[Display: ivrname, cluster, description]
    FormDisplay --> UserFills[User fills fields, Submit]
    UserFills --> Submit{POST save or endsave?}
    Submit -->|No| FormDisplay
    Submit -->|Yes| SaveNew[saveNew]
    SaveNew --> Validate[pkey required]
    Validate --> ValidOK{Valid?}
    ValidOK -->|No| SetInvalid[invalidForm, error_hash, showNew]
    ValidOK -->|Yes| BuildTuple[buildTupleArray POST, tuple]
    BuildTuple --> Insert[createTuple ivrmenu]
    Insert --> InsertOK{ret = OK?}
    InsertOK -->|No| SetInvalid
    InsertOK -->|Yes| SaveKey[saveKey = pkey, showEdit]
    ShowEdit([User sees edit screen])
  </div>

  <h2>2. showForm() routing (add-related branches only)</h2>
  <div class="mermaid">
flowchart TD
    ShowForm([showForm entry]) --> A{POST new or GET new?}
    A -->|Yes| ShowNew[showNew return]
    A -->|No| B{POST save or endsave?}
    B -->|Yes| SaveNew[saveNew]
    SaveNew --> Invalid{invalidForm?}
    Invalid -->|Yes| ShowNew2[showNew return]
    Invalid -->|No| ShowEdit[showEdit return]
    B -->|No| C[Other actions...]
  </div>

  <h2>3. saveNew() – validation and create</h2>
  <div class="mermaid">
flowchart TD
    SaveNew([saveNew]) --> Val[FormValidator: pkey req]
    Val --> ValOK{ValidateForm?}
    ValOK -->|No| Invalid[invalidForm, GetErrors]
    ValOK -->|Yes| Build[buildTupleArray POST, tuple]
    Build --> Create[createTuple ivrmenu, tuple]
    Create --> OK{ret = OK?}
    OK -->|No| Invalid
    OK -->|Yes| Message[message, saveKey = pkey]
  </div>
</body>
</html>
